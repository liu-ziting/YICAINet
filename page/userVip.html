<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>医采网-VIP会员充值</title>
	<link rel="stylesheet" href="../layui/css/layui.css" />
	<link rel="stylesheet" href="../css/index.css" />
</head>

<body>
	<!--头部-->
	<header>
		<div class="htop">
			<div class="centered">
				<div class="left">
					<p>欢迎来到医采网！</p>
					<img class="loginIcon" src="../img/user.png" />
					<span class="topLoginBox">
						<a class="login" href="login.html">登录 &nbsp;&nbsp;|</a>
						<a class="register" href="register.html">免费注册</a>
						<a class="userTop" href="user.html">个人中心</a>
						<span onclick="openUrl('inform.html')" class="unreadSizeTop"></span>
					</span>
				</div>
				<div class="right">
					<img src="../img/iPhone.png" />
					<p>免费咨询热线：0551-65311145</p>
					<span>|</span>
					<p onclick="addFavorite()">收藏 </p>
					<span>|</span>
					<p>帮助</p>
				</div>
			</div>
		</div>
		<div class="searchBox">
			<div class="centered">
				<a class="logo" href="../index.html">
					<img src="../img/logo.png" />
				</a>
				<!--搜索-->
				<div class="rightBox">
					<div class="toptab">
						<span class="active">查询药品</span>
						<span>查询耗材</span>
						<span>查询设备</span>
					</div>
					<div class="search">
						<input type="text" name="title" required lay-verify="required" placeholder="请输入搜索关键词"
							autocomplete="off" class="layui-input">
						<span>
							<img src="../img/ss.png" />
						</span>
					</div>
				</div>
			</div>
		</div>
		<!--导航-->
		<nav>
			<div class="centered">
				<ul>
					<li onclick="openUrl('../index.html')">首页</li>
					<li onclick="openUrl('callForBids.html')">招标采购信息</li>
					<li onclick="openUrl('drugList.html')">药品信息</li>
					<li onclick="openUrl('materialsList.html')">耗材信息</li>
					<li onclick="openUrl('facilityList.html')">设备信息</li>
					<li onclick="openUrl('policy.html')">政策法规</li>
					<li onclick="openUrl('download.html')">下载中心</li>
					<li onclick="openUrl('contactUs.html')">联系我们</li>
				</ul>
			</div>
		</nav>
	</header>
	<div id="userVip" class="user centered">
		<div class="left">
			<h1 onclick="openUrl('user.html')">
				<p>会员中心</p><span>My home page</span>
			</h1>
			<div class="leftTab">
				<h2>
					<img src="../img/user1.png" />
					<span>账户信息</span>
				</h2>
				<ul>
					<li onclick="openUrl('userMy.html')">个人信息</li>
					<li onclick="openUrl('editPhone.html')">修改绑定手机号</li>
				</ul>
				<h2>
					<img src="../img/user2.png" />
					<span>财务中心</span>
				</h2>
				<ul>
					<li class="active" onclick="openUrl('userVip.html')">VIP会员充值</li>
					<li onclick="openUrl('rechargeRecord.html')">充值记录</li>
				</ul>
				<h2>
					<img src="../img/user2.png" />
					<span>服务中心</span>
				</h2>
				<ul>
					<li onclick="openUrl('inform.html')">系统通知<span class="unreadSize"></span></li>
					<li onclick="openUrl('userHelp.html')">服务帮助</li>
				</ul>
				<button type="button" onclick="logout()" class="layui-btn quit">退出</button>
			</div>
		</div>
		<div class="right">
			<div class="userVip">
				<h1 class="usertitle">
					VIP会员充值
					<p>当前位置：<a href="user.html">个人中心</a> >> <a href="#">财务中心</a>>> <a href="userHelp.html">VIP会员充值</a></p>
				</h1>
				<section>
					<ul>
						
						<li id="payList">
							<!--<div>
								<h1>30元<span>35元/月</span></h1>
								<p>包月会员立减5元</p>
							</div>-->
						</li>
						<li>
							<h2>支付<span>方式</span></h2>
							<div class="wechat">
				    			<i class="wicon"></i>
				    			<span>微信</span>
				    			<input type="hidden" class="payChannel" value="wechat_pay_pc" />
				    		</div>
				    		<div class="alipay">
				    			<i class="zicon"></i>
				    			<span>支付宝</span>
				    			<input type="hidden" class="payChannel" value="ali_pay_pc" />
				    		</div>
						</li>
						<li id="wxPayBox" style="display: none;">
							<p>扫描二维码进行支付：</p>
							<div class="ewm">
								<div class="qrcode">
						    		<img src="" />
						    	</div>
						    	<!-- <p>已为您优惠5元</p>
						    	<h3>￥30.00</h3> -->
						    	<!-- <i>推荐使用微信支付</i>
						    	<i>会员相关请阅读<a id="openNotice" href="javascript:;">《会员须知》</a></i> -->
							</div>
						</li>
					
					</ul>
				</section>
			</div>
		</div>
	</div>
	<div id="footer"></div>
	<script type="text/javascript" src="../js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../layui/layui.all.js"></script>
	<script type="text/javascript" src="../js/main.js"></script>
	<script>
		
		//支付切换
		$(".userVip ul li:nth-child(2) div").click(function(){
			$(this).addClass("active").siblings().removeClass("active");
			getPayInfo();	
		});
		
		//支付接口
		function getPayInfo(){
			var payChannel = $(".userVip ul li:nth-child(2) .active .payChannel").val();
			var id = $(".userVip ul li:nth-child(1) .active").attr("id")
			http.ajax({
				url: 'goods/get_pay_info',
				type: 'GET',
				json: false,
				mask: true,
				data: {
					id:id,
					payChannel:payChannel,
					operationType:'recharge',
					terminalType:'pc'
				}
			}).then(function(data) {
				if(data.code == 200) {
					var json = JSON.parse(data.data);
						var payNo = json.payNo;
						var payUrl = json.payUrl;
					if(payChannel == 'ali_pay_pc'){
						
						localStorage.setItem("payUrl",payUrl);
						localStorage.setItem("payNo",payNo);
						window.open('pay.html');
						getPayResult(payNo);
					}else if(payChannel == 'wechat_pay_pc'){
						$("#wxPayBox").show();
						$(".qrcode img").attr("src",payUrl);
						getPayResult(payNo);
					};
				}
			}, function(err) {
				
			})
		};
		
		//商品列表
		goodsList();
		function goodsList(){
			http.ajax({
				url: 'goods/goods_list',
				type: 'GET',
				json: false,
				mask: true,
				data: {
					pageNo: 1,
					pageSize: 3
				}
			}).then(function (data) {
				var result = data.data;
				var iHTML = ""
				if (data.code == 200) {
					for (var i = 0; i < result.items.length; i++) {
						iHTML +='<div id='+result.items[i].id+'><h1>'+result.items[i].realPrice+'元<span>'+result.items[i].price+'元</span></h1><p>'+result.items[i].name+'</p></div>';
					};
					$("#payList").append(iHTML);
					$("#payList div:first-child").addClass("active");
					//会员切换
					$(".userVip ul li:nth-child(1) div").click(function(){
						$(this).addClass("active").siblings().removeClass("active");
					});
				}
			}, function (err) {
				
			});
		};
		//查询支付结果
		function getPayResult(payNo){
			http.ajax({
				url: 'goods/get_pay_result',
				type: 'GET',
				json: false,
				mask: false,
				data: {
					payNo:payNo
				}
			}).then(function(data) {
				var payChannel = $(".buyBook ul li:nth-child(2) .active .payChannel").val();
				if(data.code == 200) {
					if(data.data == "success"){
						//支付成功
						layer.msg('恭喜您，充值成功！', {
							icon: 1
						}, function() {
							update_token();
							location.href = 'user.html';
						});
					}else if(data.data == "failed"){
						//支付失败
						layer.msg('支付失败！', {
							icon: 5
						},function(){
							window.location.reload();
						});
					}else{
						getPayResult(payNo);
					}
				}
			}, function(err) {
				
			})
		};
		//用户协议弹窗
		$("#openNotice").click(function(){
			layer.open({
			  type: 2,
			  title: '平台协议须知',
			  shadeClose: true,
			  shade: 0.8,
			  area: ['480px', '90%'],
			  content: 'notice.html' 
			}); 
		});
		
	</script
	</script>
</body>

</html>